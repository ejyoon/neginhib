---
title: "Nordmeyer, Yoon, & Frank, Cogsci 2016"
author: "Ann E. Nordmeyer"
output: 
  html_document:
    toc: true
---

Analysis for Neginhib (Ann Nordmeyer, Erica Yoon, Mike Frank).  The study included three games designed to test the relationship between inhibitory control, implicature processing, and negation processing.  All games had a similar structure: participants saw two pictures and heard a word, and had to select the picture that goes with the word as quickly as possible.  Each game had two trial types, labeled *control* and *target* in these analyses. 
The three games were: 

**Inhibition Game** : Participants saw several identical trials in a row (e.g. the word "apple" with pictures of an apple and a cookie) and then saw a trial with the same pictures but a different word (e.g. "cookie" with pictures of an apple and a cookie).  The repeated trials in each run are the *control* trials and the final trial in each run was the *target* trial, designed to measure inhibitory control.  

**Implicature Game**: On *control* / unambiguous trials, participants saw two single pictures (e.g. a picture of an apple and a picture of a cookie) and heard a word referring to one of the pictures (e.g. "apple").  On *target* / implicatures trials, participants saw a picture with a single item and a picture with the same item paired with another item (e.g. a picture of an apple, and a picture of an apple and a cookie) and heard e.g. "apple".  The "correct" response on these trials is the response generated by the ad-hoc implicature, e.g. that "apple" must refer to the single apple because otherwise the speaker would have said "cookie".  

**Negation Game**: On *control* / positive trials, participants saw two pictures and heard a word referring to one of the pictures (e.g. a picture of an apple and a picture of a cookie, with the word "apple").  On *target* / negative trials, participants saw two pictures and heard a word negating one of the pictures (e.g. a picture of an apple and a picture of a cookie, with the words "no apple").


Kids played these games at the CDM on a computer (4, 5, and 6-year-olds), with 60 trials per game.  Adults completed the task on MTurk, with 120 trials per game.  The adult version of the task can be viewed here: 
https://langcog.stanford.edu/expts/EJY/neginhib/v1/turk/neginhib_mturk.html


# Setting up

Load required Libraries

```{r libraries}
rm(list=ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(magrittr)
library(RWiener)
library(knitr)
library(bootstrap)
library(gridExtra)
library(effsize)
library(lme4)
library(GGally)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE, warning=FALSE, message=FALSE)
```

Some useful functions:
```{r functions}
# number of unique subs
n.unique <- function (x) {
  length(unique(x))
}

# for bootstrapping 95% confidence intervals
theta <- function(x,xdata) {mean(xdata[x])}
ci.low <- function(x) {
  quantile(bootstrap(1:length(x),1000,theta,x)$thetastar,.025)}
ci.high <- function(x) {
  quantile(bootstrap(1:length(x),1000,theta,x)$thetastar,.975)}
```

Load in data

RT trimming:

* Planned analysis: +/- 3SDs in log space
* Post-hoc: also trim decisions < 200 ms from word onsent, > 15s (!) after offset, do this before planned outlier exclusion, doesn't change the results but makes things more reasonable. 

```{r loaddata}
d.turk <- read.csv("../long_data/long_data_mturk.csv") 
n.turk.initial <- n.unique(d.turk$subid)

d.turk <- d.turk %>%
  # remove anyone who played fewer than 300 trials (means they did not complete at least half of the third game) or over 408 trials (means they completed the task twice, because 408 is max number of trials -- this only happened for one participant and I'm not sure how they were able to do this, so I'm rejecting them)
  mutate(subid = factor(subid)) %>%
  group_by(subid) %>%
  mutate(ntrials = n()) %>%
  filter(ntrials > 300 & ntrials < 408) %>%
  ungroup() %>%
  # create resp and rt vars
  mutate(resp = factor(response, levels=c("Y","N"), labels=c("upper","lower")), 
         q = rt/1000) %>%
  # remove outlier RTs
  filter(rt > 200, 
         rt < 15000) %>% # filtering the mysterious neg rt...
  filter(log(rt) < mean(log(rt)) + 3 * sd(log(rt)), 
         log(rt) > mean(log(rt)) - 3 * sd(log(rt))) %>%
  # clean up
  select(subid, game, trial.num, trial.type, q, resp) %>%
  mutate(agegroup = "adults") %>%
  ungroup() 
n.turk.final <- n.unique(d.turk$subid)

d.cdm.raw <- read.csv("../long_data/long_data_cdm.csv") %>%
  filter(agegroup == 4 | agegroup == 5 | agegroup == 6) 
n.cdm.initial <- n.unique(d.cdm.raw$subid)

d.cdm <- d.cdm.raw %>%
  # remove any child who played fewer than 150 trials (means they didn't complete at least half of the final game)
  group_by(subid) %>%
  mutate(ntrials = n()) %>%
  filter(ntrials > 150) %>%
  ungroup() %>%
  group_by(agegroup) %>% #Note: doing rt trimming within age group for this sample
  # create resp and rt vars
  mutate(resp = factor(response, levels=c("Y","N"), labels=c("upper","lower")), 
         q = rt/1000) %>%
  # remove outlier RTs
  filter(rt > 200,
         rt < 15000) %>% # filtering the mysterious neg rt...
  filter(log(rt) < mean(log(rt)) + 3 * sd(log(rt)), 
         log(rt) > mean(log(rt)) - 3 * sd(log(rt))) %>%
  ungroup() 
m_age_comp <- aggregate(age ~ agegroup, d.cdm, mean)
min_age_comp <- aggregate(age ~ agegroup, d.cdm, min)
max_age_comp <- aggregate(age ~ agegroup, d.cdm, max)

d.cdm <- d.cdm %>%
  # clean up
  select(subid, age, agegroup, game, trial.num, trial.type, q, resp) %>%
  mutate(agegroup = factor(agegroup)) %>%
  ungroup() 
n.cdm.final <- n.unique(d.cdm$subid)
ns.cdm <- aggregate(subid ~ agegroup, d.cdm, n.unique)

d <- bind_rows(d.turk, d.cdm)

d$subid <- factor(d$subid)

d$agegroup <- factor(d$agegroup, levels = c("adults", "4", "5", "6"))

d$trial.labels <- factor(d$trial.type, levels = c("control", "inhib", "unambiguous", "implicature", "positive", "negative"))

d$correct <- as.numeric(as.character(factor(d$resp, 
                                            levels=c("upper","lower"), 
                                            labels=c("1","0"))))==1

d$trial.type <- factor(d$trial.type %in% c("inhib","implicature","negative"), 
                       levels = c(FALSE, TRUE), 
                       labels = c("control","target"))

d$game <- factor(d$game, levels=c("inhibition","implicature","negation"))

d <- d %>%
  mutate(agegroup2 = ifelse(agegroup == "adults", "adults", "kids"))

```

We excluded `r n.turk.initial - n.turk.final` adult participants and `r n.cdm.initial - n.cdm.final` child participants for failing to complete at least half of the trials in each game.  This left a final sample of `r n.turk.final` adult participants and `r n.cdm.final` child participants (`r ns.cdm[1,2]` 4-year-olds (age range `r min_age_comp[1,2]`-`r max_age_comp[1,2]`, mean age = `r round(m_age_comp[1,2], digits = 2)`), `r ns.cdm[2,2]` 5-year-olds (age range `r min_age_comp[2,2]`-`r max_age_comp[2,2]`, mean age = `r round(m_age_comp[2,2], digits = 2)`), and `r ns.cdm[3,2]` 6-year-olds (age range `r min_age_comp[3,2]`-`r max_age_comp[3,2]`, mean age = `r round(m_age_comp[3,2], digits = 2)`)).  

# Initial analysis

## Proportion Correct

Proportion correct:
```{r propcorrect, fig.width=5, fig.height=1.7}
ms.acc <- d %>%
  group_by(game, trial.type, subid, agegroup) %>%
  summarise(m = mean(correct)) %>%
  group_by(game, trial.type, agegroup) %>%
  summarise(cih = ci.high(m),
            cil = ci.low(m),
            m = mean(m)) 
ms.acc$agegroup <- factor(ms.acc$agegroup, 
                      levels = c("4", "5", "6", "adults"), 
                      labels =  c("4", "5", "6", "Adults"))
ms.acc$trial.type <- factor(ms.acc$trial.type, labels = c("Control", "Target"))
ms.acc$game <- factor(ms.acc$game, labels = c("Inhibition", "Implicature", "Negation"))
ms.acc$kid <- ms.acc$agegroup != "Adults"

qplot(data = ms.acc, x = agegroup, y = m, color = trial.type, 
      geom = "point", position = position_dodge(.2)) + 
  geom_errorbar(aes(ymin = cil, ymax = cih), 
                position = position_dodge(.2), width = 0) + 
  geom_line(aes(group = interaction(kid,trial.type), col = trial.type)) + 
  facet_grid( ~ game) +
  ylab("Proportion correct") + xlab("Age Group") +
  scale_color_hue(name = "Trial Type") +
  theme_bw()
```
So kids are much less accurate than adults on target trials, especially in the implicature and negation games.  In general, both adults and kids have lower accuracy on target trials.  It looks children show some improvement on the implicatures game across development but maybe not so much improvement across development on the negation game?

Do kids differ from adults in accuracy?

```{r propcorrect_models1}
##Inhibition: 
correct.inhib <- glmer(correct ~ trial.type * agegroup2 + (trial.type | subid), 
                             data = filter(d, game == "inhibition"), 
                             family = "binomial")
kable(summary(correct.inhib)$coefficients, digits = 3)

##Implicature:
correct.imp <- glmer(correct ~ trial.type * agegroup2 + (trial.type | subid), 
                             data = filter(d, game == "implicature"),
                             family = "binomial")
kable(summary(correct.imp)$coefficients, digits = 3)

##Negation: 
correct.neg <- glmer(correct ~ trial.type * agegroup2 + (trial.type | subid), 
                             data = filter(d, game == "negation"), 
                             family = "binomial")
kable(summary(correct.neg)$coefficients, digits = 3)
```

Is there developmental change from 4 to 6 years?
```{r propcorrect_models2}
##Inhibition: 
correct.inhib.kids <- glmer(correct ~ trial.type * age + (trial.type | subid), 
                             data = filter(d, game == "inhibition",
                                           agegroup != "adults"), 
                             family = "binomial")
kable(summary(correct.inhib.kids)$coefficients, digits = 3)

##Implicature:
correct.imp.kids <- glmer(correct ~ trial.type * age + (trial.type | subid), 
                             data = filter(d, game == "implicature",
                                           agegroup != "adults"), 
                             family = "binomial")
kable(summary(correct.imp.kids)$coefficients, digits = 3)

##Negation: 
correct.neg.kids <- glmer(correct ~ trial.type * age + (trial.type | subid), 
                             data = filter(d, game == "negation",
                                           agegroup != "adults"), 
                             family = "binomial")
kable(summary(correct.neg.kids)$coefficients, digits = 3)
```



## Reaction time

What about reaction time?  Here we just look at RTs on correct trials (outlier RTs were trimmed earlier when the data was loaded).

```{r rt_adults, fig.width=5, fig.height=1.7}
#Plot data
ms.rt <- d %>%
  filter(correct == TRUE) %>%
  group_by(game, trial.type, subid, agegroup) %>%
  summarise(m = mean(q)) %>%
  group_by(game, trial.type, agegroup) %>%
  summarise(cih = ci.high(m),
            cil = ci.low(m),
            m = mean(m)) 
ms.rt$agegroup <- factor(ms.rt$agegroup, 
                      levels = c("4", "5", "6", "adults"), 
                      labels = c("4", "5", "6", "Adults"))
ms.rt$game <- factor(ms.rt$game, labels = c("Inhibition", "Implicature", "Negation"))
ms.rt$trial.type <- factor(ms.rt$trial.type, labels = c("Control", "Target"))

ms.rt$kid <- ms.rt$agegroup != "Adults"
qplot(data = ms.rt, x = agegroup, y = m, color = trial.type, 
      geom = "point", position = position_dodge(.2)) + 
  geom_errorbar(aes(ymin = cil, ymax = cih), 
                position = position_dodge(.2), width = 0) + 
  geom_line(aes(group = interaction(kid,trial.type), col = trial.type)) + 
  facet_grid( ~ game) +
  ylab("RT (s)") + xlab("Age Group") +
  scale_color_hue(name = "Trial Type") +
  theme_bw()
```

Are kids significantly slower than adults?

```{r rt_models1}
##Inhibition: 
rt.inhib <- lmer(q ~ trial.type * agegroup2 + (trial.type | subid), 
                             data = filter(d, game == "inhibition",
                                           correct == TRUE))
kable(summary(rt.inhib)$coefficients, digits = 3)

##Implicature:
rt.imp <- lmer(q ~ trial.type * agegroup2 + (trial.type | subid), 
                             data = filter(d, game == "implicature",
                                           correct == TRUE))
kable(summary(rt.imp)$coefficients, digits = 3)

##Negation: 
rt.neg <- lmer(q ~ trial.type * agegroup2 + (trial.type | subid), 
                             data = filter(d, game == "negation",
                                           correct == TRUE))
kable(summary(rt.neg)$coefficients, digits = 3)
```

Do kids RTs change developmentally?

```{r rt_models2}
##Inhibition: 
rt.inhib.kids <- lmer(q ~ trial.type * age + (trial.type | subid), 
                             data = filter(d, game == "inhibition",
                                           agegroup != "adults", 
                                           correct == TRUE))
kable(summary(rt.inhib.kids)$coefficients, digits = 3)

##Implicature:
rt.imp.kids <- lmer(q ~ trial.type * age + (trial.type | subid), 
                             data = filter(d, game == "implicature",
                                           agegroup != "adults", 
                                           correct == TRUE))
kable(summary(rt.imp.kids)$coefficients, digits = 3)

##Negation: 
rt.neg.kids <- lmer(q ~ trial.type * age + (trial.type | subid), 
                             data = filter(d, game == "negation",
                                           agegroup != "adults", 
                                           correct == TRUE))
kable(summary(rt.neg.kids)$coefficients, digits = 3)
```

So it looks like for both adults and children there is only an effect of trial type (e.g. control vs. target) on the inhibition game, where both adults and children were slower on the target trials.  Older children are faster than younger children, on all games.

##Individual Differences

Is there any correlation between an individual's performance on one game vs. another game?

```{r indif}
ms.acc.kids <- d %>%
  filter(agegroup2 == "kids") %>%
  group_by(subid, game, trial.type) %>%
  summarise(correct = mean(correct)) %>%
  spread(trial.type, correct) %>%
  mutate(sdiff = scale(target - control)) %>%
  select(-control, -target) %>%
  spread(game, sdiff)

ms.acc.adults <- d %>%
  filter(agegroup2 == "adults") %>%
  group_by(subid, game, trial.type) %>%
  summarise(correct = mean(correct)) %>%
  spread(trial.type, correct) %>%
  mutate(sdiff = scale(target - control)) %>%
  select(-control, -target) %>%
  spread(game, sdiff)

ms.rt.kids <- d %>%
  filter(correct == TRUE, agegroup2 == "kids") %>%
  group_by(subid, game, trial.type) %>%
  summarise(rt = mean(q)) %>%
  spread(trial.type, rt) %>%
  mutate(sdiff = scale(target - control)) %>%
  select(-control, -target) %>%
  spread(game, sdiff)

ms.rt.adults <- d %>%
  filter(correct == TRUE, agegroup2 == "adults") %>%
  group_by(subid, game, trial.type) %>%
  summarise(rt = mean(q)) %>%
  spread(trial.type, rt) %>%
  mutate(sdiff = scale(target - control)) %>%
  select(-control, -target) %>%
  spread(game, sdiff)
```

First let's look at individual differences in accuracy for adults: 

```{r indif_acc_adults}
ggpairs(data = ms.acc.adults, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

inhibimp_accadults <- cor.test(ms.acc.adults$inhibition, ms.acc.adults$implicature)
inhibneg_accadults <- cor.test(ms.acc.adults$inhibition, ms.acc.adults$negation)
negimp_accadults <- cor.test(ms.acc.adults$negation, ms.acc.adults$implicature)
```
There is no significant correlation between inhibition and implicature accuracy (r = `r round(inhibimp_accadults$estimate, digits = 2)`, p = `r round(inhibimp_accadults$p.value, digits = 2)`) or inhibition and negation accuracy (r = `r round(inhibneg_accadults$estimate, digits = 2)`, p = `r round(inhibneg_accadults$p.value, digits = 2)`).  

What about for kids' accuracy?

```{r indif_acc_kids}
ggpairs(data = ms.acc.kids, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

inhibimp_acckids <- cor.test(ms.acc.kids$inhibition, ms.acc.kids$implicature)
inhibneg_acckids <- cor.test(ms.acc.kids$inhibition, ms.acc.kids$negation)
negimp_acckids <- cor.test(ms.acc.kids$negation, ms.acc.kids$implicature)
```

There is no significant correlation between inhibition and implicature accuracy (r = `r round(inhibimp_acckids$estimate, digits = 2)`, p = `r round(inhibimp_acckids$p.value, digits = 2)`) or inhibition and negation accuracy (r = `r round(inhibneg_acckids$estimate, digits = 2)`, p = `r round(inhibneg_acckids$p.value, digits = 2)`).  

Now let's look at individual differences in reaction time for adults:

```{r indif_rt_adults}
ggpairs(data = ms.rt.adults, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

inhibimp_rtadults <- cor.test(ms.rt.adults$inhibition, ms.rt.adults$implicature)
inhibneg_rtadults <- cor.test(ms.rt.adults$inhibition, ms.rt.adults$negation)
negimp_rtadults <- cor.test(ms.rt.adults$negation, ms.rt.adults$implicature)
```

There is no significant correlation between inhibition and implicature reaction time (r = `r round(inhibimp_rtadults$estimate, digits = 2)`, p = `r round(inhibimp_rtadults$p.value, digits = 2)`) or inhibition and negation reaction time (r = `r round(inhibneg_rtadults$estimate, digits = 2)`, p = `r round(inhibneg_rtadults$p.value, digits = 2)`).  

There is a small marginally significant correlation between adults' RT on the negation game and the implicature game (r = `r round(negimp_rtadults$estimate, digits = 2)`, p = `r round(negimp_rtadults$p.value, digits = 2)`).  

What about kids' RT?

```{r indif_rt_kids}
ggpairs(data = ms.rt.kids, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

inhibimp_rtkids <- cor.test(ms.rt.kids$inhibition, ms.rt.kids$implicature)
inhibneg_rtkids <- cor.test(ms.rt.kids$inhibition, ms.rt.kids$negation)
negimp_rtkids <- cor.test(ms.rt.kids$negation, ms.rt.kids$implicature)
```

There is no significant correlation between inhibition and implicature reaction time (r = `r round(inhibimp_rtkids$estimate, digits = 2)`, p = `r round(inhibimp_rtkids$p.value, digits = 2)`) or inhibition and negation reaction time (r = `r round(inhibneg_rtkids$estimate, digits = 2)`, p = `r round(inhibneg_rtkids$p.value, digits = 2)`).  

# Diffusion Analysis

For the diffusion analysis, we estimated parameters separately for each trial type within each game.  Parameters are estimated within each subject and then we aggregate across subjects to get means & confidence intervals on the parameters.

## Plot densities
Plots show density of RTs for correct (pink) and incorrect responses (green), for each trial type.  You can kind of see the speed-accuracy tradeoff in some of these plots, especially the inhibition trials.  

```{r densities, fig.width=10, fig.height=8}
#Make a bunch of plots:
ggplot(d, aes(x = q)) + 
  geom_density(aes(group = resp, colour = resp, fill = resp), alpha = 0.3) +
  facet_grid(agegroup ~ game + trial.type, scales = "free") + 
  scale_fill_hue(labels = c("incorrect", "correct")) +
  scale_color_hue(labels = c("incorrect", "correct")) +
  theme_bw()
```

## Estimating parameters

We calculated parameters for each trial type separately, within each subject.  Then we aggregated across subjects to get means & confidence intervals on the parameters, and plotted the parameters across each game & trial type.

```{r setuppars}
sub.pars <- data.frame(Separation = numeric(),
                       Non.Decision = numeric(),
                       Bias = numeric(),
                       Drift = numeric(),
                       Trial.Type = character(),
                       SubID = character(), 
                       Age = character())
sub.pars$Trial.Type <- as.character(sub.pars$Trial.Type)
sub.pars$SubID <- as.character(sub.pars$SubID)
sub.pars$Age <- as.character(sub.pars$Age)

temp.pars <- sub.pars

#because RWiener is finicky:
d$resp <- as.character(d$resp)
```

```{r estpars}
trialtypes <- c("control", "inhib", "unambiguous", "implicature", "positive", "negative")
subs <- unique(d$subid)

for (j in 1:length(subs)) {
  sid <- as.character(subs[j]) 
  for (i in 1:length(trialtypes)) {
    ttype <- as.character(trialtypes[i])
    dat <- as.data.frame(subset(d, trial.labels == ttype & subid == sid))
    opt <- optim(c(1, .1, .1, 1), wiener_deviance, 
                 dat=select(dat, c(q, resp)), method="Nelder-Mead")
    pars <- c(opt$par, ttype, sid, as.character(dat$agegroup[1]))
    temp.pars[i,] <- pars
  }
  sub.pars <- rbind(temp.pars, sub.pars)
  temp.pars <- temp.pars[0, ]
} 
```

### Plot Parameters: 

This plot shows the mean parameter values & 95% C.I.s for each game/trial type.

```{r plotpars, fig.width=8, fig.height=6}
sub.pars <- sub.pars %>%
  mutate(Condition = ifelse(Trial.Type == "control" | Trial.Type == "positive" | Trial.Type == "unambiguous", "Control", "Target"),
         Game = ifelse(Trial.Type == "control" | Trial.Type == "inhib", "inhibition", ifelse(Trial.Type == "positive" | Trial.Type == "negative", "negation", "implicature")))

sub.pars$Separation <- as.numeric(sub.pars$Separation)
sub.pars$Non.Decision <- as.numeric(sub.pars$Non.Decision)
sub.pars$Bias <- as.numeric(sub.pars$Bias)
sub.pars$Drift <- as.numeric(sub.pars$Drift)
sub.pars$Kids <- sub.pars$Age != "adults"

sub.pars <- sub.pars %>% 
  group_by(Game, Kids) %>%
  filter(Separation < mean(Separation) + 3 * sd(Separation), 
         Separation > mean(Separation) - 3 * sd(Separation)) %>%
  filter(Non.Decision < mean(Non.Decision) + 3 * sd(Non.Decision), 
         Non.Decision > mean(Non.Decision) - 3 * sd(Non.Decision)) %>%
  filter(Bias < mean(Bias) + 3 * sd(Bias), 
         Bias > mean(Bias) - 3 * sd(Bias)) %>%
  filter(Drift < mean(Drift) + 3 * sd(Drift), 
         Drift > mean(Drift) - 3 * sd(Drift)) %>%
  ungroup() %>%
  na.omit()

sub.pars.ms <- sub.pars %>%
  gather(Param, Value, Separation:Drift) %>%
  group_by(Age, Condition, Game, Param) %>%
  summarise(M = mean(Value),
            cih = ci.high(Value),
            cil = ci.low(Value))
sub.pars.ms$Game <- factor(sub.pars.ms$Game, levels = c("inhibition", "implicature", "negation"))

qplot(data = filter(sub.pars.ms), x = Age, color = Condition,
      y = M, ymax=cih, ymin=cil, 
      geom = "pointrange", position = position_dodge(.25)) +
  facet_grid(Param ~ Game, scales = "free") +
  theme_bw()
```

### Plot diffusion process:

We can also take these parameters and visualize the actual diffusion process for each game/trial type/age group:

```{r parvis, fig.width=8, fig.height=5}
#Visualize diffusion process for each game & trial type

games <- c("inhibition", "implicature", "negation")
age <- unique(sub.pars.ms$Age)
p <- list()

#graph axes
x <- 2
y <- 4

for (a in 1:length(age)) {
    for (g in 1:length(games)) {
    params <- sub.pars.ms %>%
      subset(Game == games[g] & Age == age[a]) %>%
      gather(Name, Value, M:cil) %>%
      unite(Stats, Param, Name) %>%
      spread(Stats, Value)
    params$yint_M = (params$Bias_M*params$Separation_M) - (params$Drift_M*params$Non.Decision_M)
    params$yint_cih = (params$Bias_M*params$Separation_M) - (params$Drift_cih*params$Non.Decision_M)
    params$yint_cil = (params$Bias_M*params$Separation_M) - (params$Drift_cil*params$Non.Decision_M)
    
    drift_ribbon <- data.frame(xvals = c(params$Non.Decision_M, #non-decision time
                                         (params$Separation_M - params$yint_cih) / params$Drift_cih, #Point where high drift line hits separation boundary
                                         (params$Separation_M - params$yint_M) / params$Drift_M, #Point where drift line hits separation boundary
                                         ifelse(params$Drift_cil > 0, (params$Separation_M - params$yint_cil) / params$Drift_cil, (0 - params$yint_cil) / params$Drift_cil)), #Point where low drift line hits separation boundary or 0
                               ymin = c(params$Bias_M * params$Separation_M, #point where drift starts
                                        params$Drift_cil*((params$Separation_M - params$yint_cih) / params$Drift_cih) + params$yint_cil, #point where low drift is when high drift ends
                                        params$Drift_cil*((params$Separation_M - params$yint_M) / params$Drift_M) + params$yint_cil, #point where low drift is when drift ends
                                        ifelse(params$Drift_cil > 0, params$Separation_M, 0)), #point where low drift ends
                               ymax = c(params$Bias_M * params$Separation_M, #point where drift starts
                                        params$Separation_M, #point where drift ends
                                         params$Separation_M, #point where drift ends
                                        params$Separation_M),#point where drift ends
                               Condition = rep(params$Condition, 4))
    
    nd_ribbon <- data.frame(xmin = params$Non.Decision_cil,
                            xmax = params$Non.Decision_cih,
                            ymin = rep(params$Bias_cil*params$Separation_cil, 2), 
                            ymax = rep(params$Bias_cih*params$Separation_cih, 2),
                            Condition = params$Condition)
    
    sep_ribbon <- data.frame(xmin = rep(c(0), 2),
                             xmax = rep(x, 2),
                             ymin = params$Separation_cil,
                             ymax = params$Separation_cih,
                             Condition = params$Condition)
    
    df <- data.frame()
    
    p[[g + 3*(a-1)]] <- ggplot(df) + coord_cartesian(xlim = c(0, x), ylim = c(0, y)) + 
      geom_point() +  theme_bw() +
      geom_segment(data = params, 
                   aes(x = Non.Decision_M, 
                       xend = (Separation_M - yint_M) / Drift_M,
                       y = Bias_M * Separation_M, yend = Separation_M, 
                       color = Condition)) + 
      geom_rect(data = nd_ribbon,
                aes(xmin = xmin,
                    xmax = xmax,
                    ymin = ymin, 
                    ymax = ymax,
                    fill = Condition), 
                alpha=0.2) +
      geom_ribbon(data = drift_ribbon, 
                  aes(x = xvals, 
                      ymin = ymin, 
                      ymax = ymax,
                      fill = Condition), 
                  alpha=0.2) +
      geom_rect(data = sep_ribbon, 
                aes(xmin = xmin,
                    xmax = xmax,
                    ymin = ymin, 
                    ymax = ymax,
                    fill = Condition), 
                alpha=0.2) +
      geom_hline(data = params, 
                 aes(yintercept = Separation_M, color = Condition),
                 linetype = "dashed") + 
      geom_hline(yintercept = 0, linetype = "dashed") + 
      geom_vline(data = params, 
                 aes(xintercept = Non.Decision_M, color = Condition)) + 
      scale_fill_discrete(guide = FALSE) +
      scale_color_discrete(guide = FALSE) +
      xlab("Time (seconds)") + ylab(paste("Boundary \n Separation")) #+ 
      #ggtitle(paste(age[a], ",", games[g], sep = " ")) 
  } 
}

plotlist <- c(list(p[[1]], p[[4]], p[[7]], p[[10]],  
                   p[[2]], p[[5]], p[[8]], p[[11]], 
                   p[[3]], p[[6]], p[[9]], p[[12]]), ncol = 4, nrow = 3)
do.call(grid.arrange, plotlist)
```

Pink = control trials and green = target trials (I removed the legend to make more space)

# DDM Statistics

## Parameter correlations

```{r ddm_corrs}
ms.sep.adults <- sub.pars %>%
  filter(Age == "adults") %>%
  select(c(Separation, SubID, Condition, Game)) %>%
  spread(Condition, Separation)  %>%
  mutate(sdiff = scale(Target - Control)) %>%
  select(-Control, -Target) %>%
  spread(Game, sdiff)

ggpairs(data = ms.sep.adults, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

ms.sep.kids <- sub.pars %>%
  filter(Age != "adults") %>%
  select(c(Separation, SubID, Condition, Game)) %>%
  spread(Condition, Separation) %>%
  mutate(sdiff = scale(Target - Control)) %>%
  select(-Control, -Target) %>%
  spread(Game, sdiff)

ggpairs(data = ms.sep.kids, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

ms.nd.adults <- sub.pars %>%
  filter(Age == "adults") %>%
  select(c(Non.Decision, SubID, Condition, Game)) %>%
  spread(Condition, Non.Decision) %>%
  mutate(sdiff = scale(Target - Control)) %>%
  select(-Control, -Target) %>%
  spread(Game, sdiff)

ggpairs(data = ms.nd.adults, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

ms.nd.kids <- sub.pars %>%
  filter(Age != "adults") %>%
  select(c(Non.Decision, SubID, Condition, Game)) %>%
  spread(Condition, Non.Decision) %>%
  mutate(sdiff = scale(Target - Control)) %>%
  select(-Control, -Target) %>%
  spread(Game, sdiff)

ggpairs(data = ms.nd.kids, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

ms.bias.adults <- sub.pars %>%
  filter(Age == "adults") %>%
  select(c(Bias, SubID, Condition, Game)) %>%
  spread(Condition, Bias) %>%
  mutate(sdiff = scale(Target - Control)) %>%
  select(-Control, -Target) %>%
  spread(Game, sdiff)

ggpairs(data = ms.bias.adults, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

ms.bias.kids <- sub.pars %>%
  filter(Age != "adults") %>%
  select(c(Bias, SubID, Condition, Game)) %>%
  spread(Condition, Bias) %>%
  mutate(sdiff = scale(Target - Control)) %>%
  select(-Control, -Target) %>%
  spread(Game, sdiff)

ggpairs(data = ms.bias.kids, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

ms.drift.adults <- sub.pars %>%
  filter(Age == "adults") %>%
  select(c(Drift, SubID, Condition, Game)) %>%
  spread(Condition, Drift) %>%
  mutate(sdiff = scale(Target - Control)) %>%
  select(-Control, -Target) %>%
  spread(Game, sdiff)

ggpairs(data = ms.drift.adults, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()

ms.drift.kids <- sub.pars %>%
  filter(Age != "adults") %>%
  select(c(Drift, SubID, Condition, Game)) %>%
  spread(Condition, Drift) %>%
  mutate(sdiff = scale(Target - Control)) %>%
  select(-Control, -Target) %>%
  spread(Game, sdiff)

ggpairs(data = ms.drift.kids, 
        columns = 2:4, 
        upper = list(continuous = "cor"),
        lower = list(continuous = "smooth")) + 
  theme_bw()
```

## Adult data t-tests
```{r adult_ttests}
sub.pars$Age <- factor(sub.pars$Age, levels = c("adults", "4", "5", "6"))
sub.pars$Condition <- factor(sub.pars$Condition)

#adult t tests
inhib.bias <- sub.pars %>%
  filter(Age == "adults", Game == "inhibition") %>%
  select(Bias, SubID, Condition) %>%
  spread(Condition, Bias)

t.test(inhib.bias$Control, inhib.bias$Target, paired = T)

inhib.nd <- sub.pars %>%
  filter(Age == "adults", Game == "inhibition") %>%
  select(Non.Decision, SubID, Condition) %>%
  spread(Condition, Non.Decision)

t.test(inhib.nd$Control, inhib.nd$Target, paired = T)

imp.sep <- sub.pars %>%
  filter(Age == "adults", Game == "implicature") %>%
  select(Separation, SubID, Condition) %>%
  spread(Condition, Separation)

t.test(imp.sep$Control, imp.sep$Target, paired = T)

imp.drift <- sub.pars %>%
  filter(Age == "adults", Game == "implicature") %>%
  select(Drift, SubID, Condition) %>%
  spread(Condition, Drift)

t.test(imp.drift$Control, imp.drift$Target, paired = T)

neg.drift <- sub.pars %>%
  filter(Age == "adults", Game == "negation") %>%
  select(Drift, SubID, Condition) %>%
  spread(Condition, Drift)

t.test(neg.drift$Control, neg.drift$Target, paired = T)

neg.nd <- sub.pars %>%
  filter(Age == "adults", Game == "negation") %>%
  select(Non.Decision, SubID, Condition) %>%
  spread(Condition, Non.Decision)

t.test(neg.nd$Control, neg.nd$Target, paired = T)
```

## Developmental Change across games

```{r child_models}

##Inhibition game
inhib <- filter(sub.pars, Game == "inhibition")

inhib.sep <- lm(Separation ~ Age * Condition, data = inhib)
kable(summary(inhib.sep)$coefficients, digits = 3)

inhib.nd <- lm(Non.Decision ~ Age * Condition, data = inhib)
kable(summary(inhib.nd)$coefficients, digits = 3)

inhib.bias <- lm(Bias ~ Age * Condition, data = inhib)
kable(summary(inhib.bias)$coefficients, digits = 3)

inhib.drift <- lm(Drift ~ Age * Condition, data = inhib)
kable(summary(inhib.drift)$coefficients, digits = 3)

##Implicature game
imp <- filter(sub.pars, Game == "implicature")

imp.sep <- lm(Separation ~ Age * Condition, data = imp)
kable(summary(imp.sep)$coefficients, digits = 3)

imp.nd <- lm(Non.Decision ~ Age * Condition, data = imp)
kable(summary(imp.nd)$coefficients, digits = 3)

imp.bias <- lm(Bias ~ Age * Condition, data = imp)
kable(summary(imp.bias)$coefficients, digits = 3)

imp.drift <- lm(Drift ~ Age * Condition, data = imp)
kable(summary(imp.drift)$coefficients, digits = 3)

##Negation game
neg <- filter(sub.pars, Game == "negation")

neg.sep <- lm(Separation ~ Age * Condition, data = neg)
kable(summary(neg.sep)$coefficients, digits = 3)

neg.nd <- lm(Non.Decision ~ Age * Condition , data = neg)
kable(summary(neg.nd)$coefficients, digits = 3)

neg.bias <- lm(Bias ~ Age * Condition, data = neg)
kable(summary(neg.bias)$coefficients, digits = 3)

neg.drift <- lm(Drift ~ Age * Condition, data = neg)
kable(summary(neg.drift)$coefficients, digits = 3)
```

## General Developmental Change

```{r generaldev_models}
#Look at changes in paramaters in general across age: 
sep.model <- lm(Separation ~ Age, data = sub.pars)
kable(summary(sep.model)$coefficients, digits = 3)

nd.model <- lm(Non.Decision ~ Age, data = sub.pars)
kable(summary(nd.model)$coefficients, digits = 3)

bias.model <- lm(Bias ~ Age, data = sub.pars)
kable(summary(bias.model)$coefficients, digits = 3)

drift.model <- lm(Drift ~ Age, data = sub.pars)
kable(summary(drift.model)$coefficients, digits = 3)

#Look at continuous across age group, just children
sub.pars.cont <- filter(sub.pars, Age != "adults")
sub.pars.cont$Age <- as.numeric(as.character(sub.pars.cont$Age))

cont.sep.model <- lm(Separation ~ Age, data = sub.pars.cont)
kable(summary(cont.sep.model)$coefficients, digits = 3)

cont.nd.model <- lm(Non.Decision ~ Age, data = sub.pars.cont)
kable(summary(cont.nd.model)$coefficients, digits = 3)

cont.bias.model <- lm(Bias ~ Age, data = sub.pars.cont)
kable(summary(cont.bias.model)$coefficients, digits = 3)

cont.drift.model <- lm(Drift ~ Age, data = sub.pars.cont)
kable(summary(cont.drift.model)$coefficients, digits = 3)
```